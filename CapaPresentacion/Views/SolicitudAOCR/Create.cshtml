@{
    ViewBag.Title = "Operador";
    Layout = "~/Views/Shared/_LayoutAOCR.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="@Url.Content("~/Content/css/dgac-theme.css")" />

    <style>
        /* --- ESTILOS ESPECÍFICOS DE LA VISTA --- */
        body {
            background-color: #f4f7fa;
        }

        .btn-white-perfect {
            background-color: #ffffff;
            color: var(--dgac-blue);
            border: 1px solid #d1d5db;
            font-weight: 700;
            padding: 10px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-white-perfect:hover {
                border-color: var(--dgac-teal);
                color: var(--dgac-teal);
                box-shadow: 0 4px 12px rgba(12, 124, 134, 0.15);
                transform: translateY(-1px);
            }

        .header-modern {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-image: radial-gradient(#eef2f5 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .table-container-responsive {
            max-height: 650px;
            overflow-y: auto;
            border-radius: 12px;
            background: white;
        }

        .table-dgac thead th {
            background-color: var(--dgac-blue);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 16px 12px;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 30px;
            background: #fff;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
        }

            .filter-tab.active {
                background: var(--dgac-blue);
                color: #fff;
            }

        .badge-pill-custom {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .bg-aprobado {
            background-color: #d1fae5;
            color: #065f46;
        }

        .bg-pendiente {
            background-color: #fef3c7;
            color: #92400e;
        }

        .bg-tramite {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .bg-observado {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
}

<div class="header-modern">
    <div>
        <h3 class="m-0 font-weight-bold text-dark">Tablero de Control</h3>
        <p class="text-muted m-0 small">Gestión de Certificados AOCR</p>
    </div>

    <div class="btn-group">
        <button type="button" class="btn btn-white-perfect dropdown-toggle" data-toggle="dropdown">
            <i class="bi bi-plus-lg text-info"></i> NUEVA SOLICITUD
        </button>
        <div class="dropdown-menu dropdown-menu-right border-0 shadow-lg p-2">
            <a class="dropdown-item rounded py-2" href="javascript:void(0)" onclick="window.cargarFormulario(null)">
                <i class="bi bi-file-earmark-plus text-primary mr-2"></i> Emisión AOCR
            </a>
            <a class="dropdown-item rounded py-2" href="#">
                <i class="bi bi-pencil-square text-info mr-2"></i> Modificación
            </a>
        </div>
    </div>
</div>

<section class="content pt-4 px-3">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="filter-tabs">
                <div class="filter-tab active" data-filter="all">Todos</div>
                <div class="filter-tab" data-filter="tramite">En Trámite</div>
                <div class="filter-tab" data-filter="aprobado">Aprobados</div>
                <div class="filter-tab" data-filter="observado">Observados</div>
            </div>

            <div class="input-group shadow-sm" style="width: 300px; border-radius: 20px; overflow: hidden; background: white;">
                <input type="text" id="searchInput" class="form-control border-0" placeholder="Buscar solicitud...">
            </div>
        </div>

        <div class="card border-0 shadow-sm" style="border-radius: 12px;">
            <div class="card-body p-0">
                <div class="table-container-responsive">
                    <table id="tablaSolicitudes" class="table table-dgac mb-0 w-100 text-center">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th class="text-left pl-4">Compañía</th>
                                <th>Estado Global</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTabla"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

@* --- ÚNICO CONTENEDOR DEL MODAL --- *@
<div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header py-3" style="background: linear-gradient(135deg, var(--dgac-blue), var(--dgac-teal)); color: white;">
                <h5 class="modal-title font-weight-bold"><i class="bi bi-window-stack mr-2"></i> Gestión de Solicitud AOCR</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body bg-light p-0" id="contenidoModal" style="min-height: 400px;">
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            // 1. DATOS SIMULADOS
            var datosGlobales = [
                { id: 105, fecha: '19/11/2025', tipo: 'EMISIÓN', comp: 'LATAM AIRLINES', st: 'Aprobado', cat: 'aprobado' },
                { id: 104, fecha: '18/11/2025', tipo: 'RENOVACIÓN', comp: 'AVIANCA S.A.', st: 'Pendiente', cat: 'tramite' },
                { id: 103, fecha: '15/11/2025', tipo: 'MODIFICACIÓN', comp: 'AEROREGIONAL', st: 'En Proceso', cat: 'tramite' }
            ];

            renderTable(datosGlobales);

            function renderTable(datos) {
                var html = '';
                $.each(datos, function (i, item) {
                    var badge = item.cat === 'aprobado' ? 'bg-aprobado' : (item.cat === 'observado' ? 'bg-observado' : 'bg-tramite');
                    html += `<tr>
                        <td class="font-weight-bold text-primary">${item.id}</td>
                        <td>${item.fecha}</td>
                        <td><span class="badge badge-light border">${item.tipo}</span></td>
                        <td class="text-left pl-4">${item.comp}</td>
                        <td><span class="badge-pill-custom ${badge}">${item.st}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="window.cargarFormulario(${item.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                $('#cuerpoTabla').html(html);
            }

            // 2. FUNCIÓN GLOBAL DE CARGA (Para Sidebar e Index)
            window.cargarFormulario = function(idSolicitud) {
                $('#modalFormulario').modal('show');
                $('#contenidoModal').html('<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Cargando Terminal AOCR...</p></div>');

                $.ajax({
                    url: '@Url.Action("FormularioEmisionAOCR", "SolicitudAOCR")',
                    type: 'GET',
                    data: { oid: idSolicitud },
                    success: function (data) {
                        $('#contenidoModal').hide().html(data).fadeIn(200);
                    },
                    error: function (xhr) {
                        $('#contenidoModal').html('<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle mr-2"></i> Error: No se pudo conectar con el servidor.</div>');
                        console.error("Detalle del error AJAX:", xhr.responseText);
                    }
                });
            };
        });
    </script>
}